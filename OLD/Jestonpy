import serial
import sqlite3
import time

# --- CONFIGURATION ---
# Connexion Arduino (Vérifie le port avec 'ls /dev/ttyACM*')
try:
    # On essaye de se connecter à l'Arduino
    ser = serial.Serial('/dev/ttyACM0', 9600, timeout=1)
    time.sleep(2) # Temps d'initialisation de la connexion
    print("Succes : Connecte a l'Arduino.")
except Exception as e:
    ser = None
    print(f"Note : Mode simulation (Arduino non detecte sur /dev/ttyACM0).")

# Initialisation de la Base de Données SQLite
conn = sqlite3.connect('dechets.db')
cursor = conn.cursor()
cursor.execute('''CREATE TABLE IF NOT EXISTS tri 
                  (objet TEXT PRIMARY KEY, couleur TEXT)''')
conn.commit()

def obtenir_ou_assigner_couleur(nom_objet):
    """
    Verifie si l'objet existe en base. 
    Sinon, demande a l'utilisateur de l'assigner.
    """
    cursor.execute("SELECT couleur FROM tri WHERE objet=?", (nom_objet.lower(),))
    resultat = cursor.fetchone()
    
    if resultat:
        return resultat[0]
    else:
        print(f"\n[NOUVEL OBJET : '{nom_objet}']")
        while True:
            choix = input("Assigner a quelle poubelle ? (jaune/verte/marron) : ").strip().lower()
            if choix in ["jaune", "verte", "marron"]:
                cursor.execute("INSERT INTO tri (objet, couleur) VALUES (?, ?)", (nom_objet.lower(), choix))
                conn.commit()
                print(f"Enregistre : {nom_objet} -> {choix}")
                return choix
            print("Erreur : Choisis entre 'jaune', 'verte' ou 'marron'.")

# --- INTERFACE DE COMMANDE MANUELLE ---
print("\n=== SYSTEME DE CONTROLE DE TRI (SANS CAMERA) ===")
print("Tape le nom d'un objet pour simuler une detection.")
print("Tape 'quitter' pour arreter.\n")

try:
    while True:
        saisie = input("Objet detecte > ").strip()
        
        if saisie.lower() == 'quitter':
            break
        
        if not saisie:
            continue

        # 1. Recuperation de la regle de tri
        couleur = obtenir_ou_assigner_couleur(saisie)
        
        # 2. Envoi de l'ordre physique
        if couleur:
            print(f"Action : Envoi du signal '{couleur}' a l'Arduino...")
            if ser:
                ser.write(f"{couleur}\n".encode())
                print("Attente de la fin du mouvement (10s)...")
                time.sleep(10) # Laisse le temps au plateau de bouger et revenir
            else:
                print("[SIMULATION] L'Arduino aurait bouge vers le bac " + couleur)
                
except KeyboardInterrupt:
    print("\nArret du programme.")
finally:
    if ser:
        ser.close()
    conn.close()
    print("Connexions fermees.")
